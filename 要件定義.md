# RSS記事通知システム要件定義書

## 1. システム概要
GoogleスプレッドシートにRSSフィードのURLリストを管理し、毎日定時に新着記事をチェックしてGoogle Chatに通知するシステム。

## 2. 機能要件

### 2.1 基本機能
- GoogleスプレッドシートからRSSフィードURLリストを取得
- 各RSSフィードから新着記事を取得
- 新着記事をGoogle Chatの指定チャンネルに通知
- 毎日6時に自動実行

### 2.2 詳細仕様

#### 2.2.1 スプレッドシート構成
| 列名 | 内容 | 型 | 備考 |
|------|------|-----|------|
| A列 | RSS URL | 文字列 | 必須 |
| B列 | フィード名 | 文字列 | 任意（空白時はURLを表示） |
| C列 | 有効フラグ | TRUE/FALSE | 通知対象の制御 |
| D列 | 最終取得日時 | 日時 | システムが自動更新 |
| E列 | エラー回数 | 数値 | 連続エラー回数を記録 |

#### 2.2.2 新着記事の判定
- 前回実行時以降に公開された記事を新着とする
- 記事の重複通知を防ぐ仕組み（記事URLベースで判定）
- スプレッドシートに最終取得日時を記録

#### 2.2.3 通知内容
- 記事タイトル
- 記事URL
- 公開日時
- フィード名（ソース）
- カード形式での見やすい表示
- フィードごとにすべての新着記事をまとめて1つの通知として送信

## 3. 非機能要件

### 3.1 パフォーマンス
- RSS取得のタイムアウト設定：30秒/フィード
- UrlFetchApp使用によるレスポンス効率化
- 最大取得記事数制限による処理時間短縮

### 3.2 可用性
- エラー発生時の継続処理（特定フィードのエラーで全体停止しない）
- 失敗したフィードはスプレッドシートにエラー回数のみ記録（詳細ログは不要）
- 連続エラー発生時の自動無効化（エラー回数が3回を超えたら無効フラグをFALSE）

### 3.3 セキュリティ
- スクリプトプロパティによるWebhook URL等の管理
- スプレッドシートへのアクセス制限（必要最小限のユーザーのみ）
- OAuth認証によるAPIアクセス

## 4. システム構成

### 4.1 利用技術・サービス
- Google Apps Script（GAS）
- Google Sheets（データ管理）
- Google Chat Webhook API
- GASトリガー機能（定時実行）

### 4.2 データフロー
1. スプレッドシートからURLリスト取得
2. 各RSSフィードを取得・解析
3. 新着記事を抽出
4. Google Chatに通知送信

## 5. 制約事項
- Google Apps Scriptの実行時間制限（6分/実行）
  - 現在想定のRSSフィード数（10件以内）では問題なく実行可能
  - 大規模化する場合は複数バッチに分割するなどの対策が必要
- UrlFetchApp の URL フェッチ回数制限（20,000回/日）
  - 現在想定のRSSフィード数（10件以内）では問題なく実行可能
  - 大規模化する場合は複数スクリプトへの分割や実行頻度の調整が必要
- RSSフィードの形式対応（RSS 2.0, Atom）
- Google Chat Webhook の投稿制限

## 6. GAS実装の詳細

### 6.1 プロジェクト構成
- スプレッドシートにバインドされたGASプロジェクト
- プロジェクトタイプ：スタンダードGASプロジェクト
- ファイル構成：
  - `Code.gs` - メインスクリプト
  - `Config.gs` - 設定関連の処理
  - `RssUtils.gs` - RSS処理ユーティリティ
  - `ChatNotifier.gs` - Google Chat通知処理
  - `ErrorHandler.gs` - エラーハンドリング処理
- 必要なサービス：UrlFetchApp、SpreadsheetApp、MailApp

### 6.2 実装する関数
1. `main()` - メイン処理
2. `getRssFeedUrls()` - スプレッドシートからURL取得
3. `getConfig()` - 設定情報取得
4. `fetchRssFeed(url)` - RSS取得・解析
5. `checkNewArticles(articles, lastFetchTime)` - 新着記事判定
6. `sendToGoogleChat(feedName, articles)` - Chat通知（フィードごとにまとめて通知）
7. `updateLastFetchTime(row, time)` - 最終取得時刻更新
8. `updateErrorCount(row, isSuccess)` - エラーカウント更新
9. `sendErrorNotification(error)` - エラー通知メール送信

### 6.3 トリガー設定
- 時間主導型トリガー：毎日午前6時に実行
- エラー通知：実行者にメール送信

### 6.4 設定項目（スクリプトプロパティ）
- `WEBHOOK_URL` - Google Chat Webhook URL
- `SHEET_ID` - スプレッドシートID（省略時は紐付けられたシート）
- `RSS_SHEET_NAME` - RSSフィード設定シート名（デフォルト：「RSS」）
- `CONFIG_SHEET_NAME` - 設定シート名（デフォルト：「Config」）

### 6.5 Google Chat Webhook URL設定手順
1. Google Chatで通知先のスペースを開く
2. スペース名をクリック → 「アプリと統合」を選択
3. 「Webhookを管理」をクリック
4. 「Webhook を追加」をクリック
5. 必要事項を入力：
   - 名前：「RSS通知」
   - アバターURL：任意のアイコン画像URL
   - （オプション）説明：「RSSの新着記事を通知します」
6. 「保存」をクリックして発行されたURLをコピー
7. GASのスクリプトプロパティに`WEBHOOK_URL`としてURLを設定

## 7. 運用要件

### 7.1 運用体制
- 運用担当者：1名
- 対応優先度：ビジネスクリティカルでないため、即時対応は不要
- 定期メンテナンス：月1回の動作確認
- 障害対応：通常営業時間内での対応

### 7.2 メンテナンス内容
- スクリプトの動作確認：月1回
- 連続エラーが発生したフィードの調査と対応
- Google Apps Scriptのバージョン管理：履歴機能の利用
- RSS URL追加・変更・削除の対応

### 7.3 バックアップと復旧
- スプレッドシートデータ：Googleドライブの自動バックアップ機能利用
- スクリプトコード：GitHub + clasp によるコード管理

#### 7.3.1 GitHub-GAS連携フロー
1. GitHubリポジトリでコードを管理
2. claspツール（Command Line Apps Script Projects）を使用して連携
3. 手動デプロイプロセス：
   - GitHub → ローカル環境へのクローン/プル
   - ローカル → GASへのプッシュ（clasp push）
   - GASでのバージョン作成とデプロイ

#### 7.3.2 必要な開発環境
- Node.js
- clasp CLI（`npm install -g @google/clasp`）
- GitHubアカウント
- `.clasp.json` ファイル（スクリプトIDを管理）

### 7.4 監視と通知
- 実行エラー発生時：運用担当者へのメール通知（GASトリガー機能）
- エラー通知内容：エラーコードとエラー詳細をそのまま通知
- 運用担当者メールアドレス：スプレッドシート内の設定シートで管理

### 7.5 設定シート（Config）
| 列名 | 内容 | 型 | 備考 |
|------|------|-----|------|
| A1 | 管理者メールアドレス | 文字列 | エラー通知先 |
| A2 | 通知タイトル | 文字列 | Chat通知のタイトル |
| A3 | アイコンURL | 文字列 | 通知時のアイコン画像 |

### 7.6 権限管理
- スプレッドシート編集権限：運用担当者のみ
- スクリプト実行権限：運用担当者のみ
- 閲覧権限：必要なユーザーのみ

## 8. テスト要件

### 8.1 単体テスト
- 各関数の動作確認
  - スプレッドシートからのデータ取得
  - RSSフィード取得・解析処理
  - 新着記事判定ロジック
  - Google Chat通知処理
  - エラーハンドリング処理

### 8.2 統合テスト
- テスト用スプレッドシートを使用した一連の動作確認
- 複数のRSSフィードに対する処理
- エラー時のハンドリング（無効なURL等）

### 8.3 受入テスト
- 本番環境での実行確認
- 通知内容の正確性
- パフォーマンスチェック（実行時間）

## 9. 今後の検討事項

### 9.1 機能拡張
- 通知先チャンネルの複数対応
- 通知条件のカスタマイズ（キーワードフィルタ等）
- 記事の要約機能
- 統計情報の可視化

### 9.2 セキュリティ強化
- RSSフィードからの悪意あるコンテンツ対策（XSSなど）
- Webhook URLの安全な管理

### 9.3 利便性向上
- 通知テンプレートのカスタマイズ機能
- 特定キーワードを含む記事のみ通知する機能
- フィードカテゴリ分けと通知グループ化

### 9.4 CI/CD導入
- GitHub ActionsによるGASへの自動デプロイ
- 単体テストの自動実行
- リリース管理の自動化